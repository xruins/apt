name: Update ab-av1

on:
  schedule:
    - cron: '0 0 * * *' # 毎日 AM 0:00 (UTC) に実行
  workflow_dispatch: # 手動実行用

permissions:
  contents: write # gh-pagesへのpushに必要

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # GPG鍵のインポート (Secretsに登録した GPG_PRIVATE_KEY を使用)
      - name: Import GPG Key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      # 必要なツール (reprepro, nfpm, zstd) のインストール
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y reprepro zstd

          # nfpm のインストール
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt-get update
          sudo apt-get install -y nfpm

      # メイン処理: バージョンチェック -> ダウンロード -> 解凍 -> パッケージ化 -> リポジトリ登録
      - name: Check version and Build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. 最新バージョンのタグを取得 (例: v0.10.3)
          LATEST_TAG=$(gh release list --repo alexheretic/ab-av1 --limit 1 | awk '{print $1}')
          # "v" を取り除く (0.10.3)
          VERSION=${LATEST_TAG#v}
          
          echo "Latest version found: $VERSION"

          # 2. 既存リポジトリに既に含まれているかチェック
          # 初回実行時など db ディレクトリがない場合はスキップ
          if [ -d "db" ]; then
             if reprepro list stable ab-av1 | grep -q "$VERSION"; then
               echo "Version $VERSION is already in the repo. Exiting."
               echo "SKIP_DEPLOY=true" >> $GITHUB_ENV
               exit 0
             fi
          fi

          echo "New version detected. Starting build process..."

          # 3. アセットのダウンロード (musl版, zstd圧縮)
          # パターン: x86_64 かつ linux かつ musl かつ tar.zst
          gh release download "$LATEST_TAG" \
            --repo alexheretic/ab-av1 \
            --pattern '*x86_64*linux*musl*.tar.zst' \
            --output ab-av1.tar.zst

          # 4. 解凍 (zstd -> tar)
          echo "Extracting archive..."
          zstd -dc ab-av1.tar.zst | tar -xv
          
          # 解凍されたバイナリに実行権限を
