name: Update ab-av1

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Import GPG Key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y reprepro
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt-get update
          sudo apt-get install -y nfpm

      - name: Check version and Build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TAG=$(gh release list --repo alexheretic/ab-av1 --limit 1 | awk '{print $1}')
          VERSION=${LATEST_TAG#v}

          echo "Latest version: $VERSION"

          if [ -d "db" ]; then
            if reprepro list stable ab-av1 | grep -q "$VERSION"; then
              echo "Version $VERSION is already in the repo. Exiting."
              echo "SKIP_DEPLOY=true" >> $GITHUB_ENV
              exit 0
            fi
          fi

          echo "New version found. Building..."

          gh release download "$LATEST_TAG" --repo alexheretic/ab-av1 --pattern '*linux-x86_64*' --output ab-av1
          chmod +x ab-av1

          export VERSION=$VERSION
          export ARCH=amd64
          nfpm pkg --packager deb --target "ab-av1_${VERSION}_amd64.deb"

          reprepro includedeb stable "ab-av1_${VERSION}_amd64.deb"
          rm ab-av1 "ab-av1_${VERSION}_amd64.deb"

          # For arm64, repeat with the aarch64 asset and ARCH=arm64.

      - name: Deploy to GitHub Pages
        if: env.SKIP_DEPLOY != 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
          keep_files: true
          exclude_assets: '.github,nfpm.yaml,private.key,conf'
